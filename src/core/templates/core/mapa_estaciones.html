{% extends 'core/base.html' %}

{% block title %}Bizi Zaragoza - Mapa del Tiempo{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 600px; 
            width: 100%; 
            border-radius: 8px; 
            z-index: 1; /* Asegurar que queda por debajo del men√∫ si este se despliega */
        }
        .control-panel { 
            background: rgba(255,255,255,0.95); 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: -20px; 
            position: relative; 
            z-index: 400; /* Por encima del mapa Leaflet */
            border: 1px solid #dee2e6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Evoluci√≥n Temporal</h3>
        <span class="badge bg-primary">√öltimas 24h</span>
    </div>
    
    <div class="card p-1 shadow-sm border-0">
        <div id="map"></div>
    </div>

    <div class="control-panel shadow text-center">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <button id="btnPlay" class="btn btn-primary rounded-pill px-4">
                ‚ñ∂ Reproducir
            </button>
            <h4 id="reloj" class="m-0 fw-bold text-primary font-monospace">--:--</h4>
        </div>
        
        <input type="range" class="form-range" id="timeSlider" min="0" max="100" step="1" value="0">
        <div class="d-flex justify-content-between text-muted small mt-1">
            <span>Pasado</span>
            <span>Ahora</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. GESTI√ìN DE FAVORITOS (LOCALSTORAGE) ---
        // Copiamos la l√≥gica para que el mapa sepa qu√© estaciones son favoritas
        const STORAGE_KEY = 'bizi_favoritos_lista';

        function getFavoritos() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        // Funci√≥n global para que el bot√≥n dentro del Popup pueda llamarla
        window.toggleMapFavorito = function(id) {
            let favs = getFavoritos();
            const idStr = String(id);
            
            if (favs.includes(idStr)) {
                favs = favs.filter(f => f !== idStr); // Quitar
            } else {
                favs.push(idStr); // A√±adir
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
            
            // Redibujamos el frame actual para que el icono del coraz√≥n cambie al instante
            const slider = document.getElementById('timeSlider');
            dibujarFrame(slider.value); 
        };

        // --- 2. CONFIGURACI√ìN DEL MAPA ---
        const timeline = JSON.parse('{{ timeline_json|escapejs }}');
        
        if (!timeline || timeline.length === 0) {
            console.warn("No hay datos hist√≥ricos suficientes.");
        }

        const slider = document.getElementById('timeSlider');
        const reloj = document.getElementById('reloj');
        const btnPlay = document.getElementById('btnPlay');
        
        // Configuramos el slider seg√∫n la cantidad de datos
        if (timeline.length > 0) {
            slider.max = timeline.length - 1;
            slider.value = timeline.length - 1; // Empezar en el final (ahora)
        }

        const map = L.map('map').setView([41.6488, -0.8891], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let marcadores = {}; 

        // --- 3. FUNCI√ìN DE DIBUJADO ---
        function dibujarFrame(index) {
            if (!timeline[index]) return;

            const frame = timeline[index];
            reloj.innerText = frame.hora_legible;
            
            const favoritos = getFavoritos(); // Obtenemos favoritos actualizados

            frame.datos.forEach(estacion => {
                // L√≥gica de colores sem√°foro
                let color;
                if (estacion.bicis === 0) {
                    color = '#dc3545'; // Rojo
                } else if (estacion.bicis <= 2) {
                    color = '#fd7e14'; // Naranja
                } else {
                    color = '#198754'; // Verde
                }
                
                // Calcular tama√±o
                const radio = (estacion.bicis === 0) ? 6 : 6 + (estacion.bicis / 5);
                
                // Verificar si es favorito
                const esFavorito = favoritos.includes(String(estacion.id));
                const corazon = esFavorito ? '‚ù§Ô∏è' : 'ü§ç';
                const bordeColor = esFavorito ? '#ff0000' : '#fff'; // Borde rojo si es fav
                const bordeGrosor = esFavorito ? 3 : 1;

                // Contenido HTML del Popup
                const contenidoPopup = `
                    <div class="text-center" style="min-width: 150px;">
                        <h6 class="fw-bold mb-2">${estacion.nombre}</h6>
                        
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-success">üö≤ ${estacion.bicis}</span>
                            <span class="badge bg-secondary">üÖøÔ∏è ${estacion.anclajes}</span>
                        </div>

                        <div class="d-grid gap-2">
                            <a href="${estacion.url_detalle}" class="btn btn-primary btn-sm text-white text-decoration-none">
                                Ver Historial üìä
                            </a>
                            <button onclick="window.toggleMapFavorito('${estacion.id}')" class="btn btn-sm btn-outline-secondary">
                                ${corazon} Favorito
                            </button>
                        </div>
                    </div>
                `;

                if (marcadores[estacion.id]) {
                    // ACTUALIZAR EXISTENTE
                    marcadores[estacion.id].setStyle({
                        fillColor: color,
                        radius: radio,
                        color: bordeColor,   // Actualizamos borde (si cambia fav)
                        weight: bordeGrosor
                    });
                    
                    // IMPORTANTE: Aqu√≠ estaba el error en tu c√≥digo anterior.
                    // Pasamos la variable directamente, no una string de c√≥digo.
                    marcadores[estacion.id].setPopupContent(contenidoPopup);

                } else {
                    // CREAR NUEVO
                    const circle = L.circleMarker([estacion.lat, estacion.lon], {
                        radius: radio,
                        fillColor: color,
                        color: bordeColor,
                        weight: bordeGrosor,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    circle.bindPopup(contenidoPopup);
                    marcadores[estacion.id] = circle;
                }
            });
        }

        // --- 4. EVENTOS ---
        slider.addEventListener('input', function() {
            dibujarFrame(this.value);
        });

        // Carga inicial
        if (timeline.length > 0) {
            dibujarFrame(slider.value);
        }

        // L√≥gica Play/Pausa
        let intervalo = null;
        btnPlay.addEventListener('click', function() {
            if (intervalo) {
                // PAUSAR
                clearInterval(intervalo);
                intervalo = null;
                btnPlay.innerHTML = "‚ñ∂ Reproducir";
                btnPlay.classList.replace('btn-danger', 'btn-primary');
            } else {
                // REPRODUCIR
                if (parseInt(slider.value) === timeline.length - 1) {
                    slider.value = 0; // Rebobinar si est√° al final
                }
                
                btnPlay.innerHTML = "‚è∏ Pausa";
                btnPlay.classList.replace('btn-primary', 'btn-danger');

                intervalo = setInterval(() => {
                    let val = parseInt(slider.value);
                    if (val < timeline.length - 1) {
                        slider.value = val + 1;
                        dibujarFrame(slider.value);
                    } else {
                        // FIN
                        clearInterval(intervalo);
                        intervalo = null;
                        btnPlay.innerHTML = "‚ñ∂ Reproducir";
                        btnPlay.classList.replace('btn-danger', 'btn-primary');
                    }
                }, 150); // Velocidad (ms)
            }
        });
    </script>
{% endblock %}