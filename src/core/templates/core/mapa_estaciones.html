{% extends 'core/base.html' %}

{% block title %}HabemusBizi - Mapa del Tiempo{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { 
            height: 600px; 
            width: 100%; 
            border-radius: 8px; 
            z-index: 1; /* Asegurar que queda por debajo del men√∫ si este se despliega */
        }
        .control-panel { 
            background: rgba(255,255,255,0.95); 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: -20px; 
            position: relative; 
            z-index: 400; /* Por encima del mapa Leaflet */
            border: 1px solid #dee2e6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Evoluci√≥n Temporal</h3>
        <span class="badge bg-primary">√öltimas 24h</span>
    </div>
    
    <div class="card p-1 shadow-sm border-0">
        <div id="map"></div>
    </div>

    <div class="control-panel shadow text-center">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <button id="btnPlay" class="btn btn-primary rounded-pill px-4">
                ‚ñ∂ Reproducir
            </button>
            <h4 id="reloj" class="m-0 fw-bold text-primary font-monospace">--:--</h4>
        </div>
        
        <input type="range" class="form-range" id="timeSlider" min="0" max="100" step="1" value="0">
        <div class="d-flex justify-content-between text-muted small mt-1">
            <span>Pasado</span>
            <span>Ahora</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. GESTI√ìN DE FAVORITOS ---
        const STORAGE_KEY = 'bizi_favoritos_lista';

        function getFavoritos() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        window.toggleMapFavorito = function(id) {
            let favs = getFavoritos();
            const idStr = String(id);
            if (favs.includes(idStr)) {
                favs = favs.filter(f => f !== idStr);
            } else {
                favs.push(idStr);
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
            // Redibujamos frame actual
            const slider = document.getElementById('timeSlider');
            dibujarFrame(slider.value); 
        };

        // --- 2. CARGA DE DATOS OPTIMIZADOS ---
        // Recibimos las dos piezas del puzzle
        const estaticos = JSON.parse('{{ estaciones_static|escapejs }}');
        const timeline = JSON.parse('{{ timeline_json|escapejs }}');
        
        if (!timeline || timeline.length === 0) {
            console.warn("No hay datos hist√≥ricos.");
        }

        const slider = document.getElementById('timeSlider');
        const reloj = document.getElementById('reloj');
        const btnPlay = document.getElementById('btnPlay');
        
        if (timeline.length > 0) {
            slider.max = timeline.length - 1;
            slider.value = timeline.length - 1; 
        }

        // Inicializar Mapa
        const map = L.map('map').setView([41.6488, -0.8891], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let marcadores = {}; 

        // --- 3. DIBUJADO DE ALTO RENDIMIENTO ---
        function dibujarFrame(index) {
            if (!timeline[index]) return;

            const frame = timeline[index];
            const lecturas = frame.d; // El diccionario comprimido {'id': [bicis, anclajes]}
            
            reloj.innerText = frame.ts; // Hora
            
            const favoritos = getFavoritos();

            // Iteramos sobre los IDs de las estaciones que tenemos en los datos est√°ticos
            // (Usamos Object.keys para recorrer el diccionario est√°tico, que es el maestro)
            Object.keys(estaticos).forEach(id => {
                const info = estaticos[id];     // Datos fijos (Nombre, Lat, Lon)
                const datos = lecturas[id];     // Datos cambiantes [Bicis, Anclajes]

                // Si por lo que sea no hay datos para esta estaci√≥n en este frame, saltamos
                if (!datos) return;

                const bicis = datos[0];
                const anclajes = datos[1];

                // L√≥gica de visualizaci√≥n
                let color;
                if (bicis === 0) color = '#dc3545';
                else if (bicis <= 2) color = '#fd7e14';
                else color = '#198754';
                
                const radio = (bicis === 0) ? 6 : 6 + (bicis / 5);
                const esFavorito = favoritos.includes(String(id));
                const bordeColor = esFavorito ? '#ff0000' : '#fff';
                const bordeGrosor = esFavorito ? 3 : 1;

                // Solo generamos el HTML del popup si el usuario hace clic (Lazy load del string)
                // Pero Leaflet necesita el bindPopup antes. Lo hacemos simple:
                const popupContent = `
                    <div class="text-center" style="min-width: 150px;">
                        <h6 class="fw-bold mb-2">${info.nombre}</h6>
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            <span class="badge bg-success">üö≤ ${bicis}</span>
                            <span class="badge bg-secondary">üÖøÔ∏è ${anclajes}</span>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="${info.url}" class="btn btn-primary btn-sm text-white text-decoration-none">
                                Ver Historial üìä
                            </a>
                            <button onclick="window.toggleMapFavorito('${id}')" class="btn btn-sm btn-outline-secondary">
                                ${esFavorito ? '‚ù§Ô∏è' : 'ü§ç'} Favorito
                            </button>
                        </div>
                    </div>
                `;

                // Actualizar o Crear Marcador
                if (marcadores[id]) {
                    marcadores[id].setStyle({
                        fillColor: color,
                        radius: radio,
                        color: bordeColor,
                        weight: bordeGrosor
                    });
                    // Leaflet permite actualizar el contenido del popup din√°micamente
                    marcadores[id].setPopupContent(popupContent);
                } else {
                    const circle = L.circleMarker([info.lat, info.lon], {
                        radius: radio,
                        fillColor: color,
                        color: bordeColor,
                        weight: bordeGrosor,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    circle.bindPopup(popupContent);
                    marcadores[id] = circle;
                }
            });
        }

        // --- 4. EVENTOS ---
        slider.addEventListener('input', function() {
            dibujarFrame(this.value);
        });

        if (timeline.length > 0) {
            dibujarFrame(slider.value);
        }

        let intervalo = null;
        btnPlay.addEventListener('click', function() {
            if (intervalo) {
                clearInterval(intervalo);
                intervalo = null;
                btnPlay.innerHTML = "‚ñ∂ Reproducir";
                btnPlay.classList.replace('btn-danger', 'btn-primary');
            } else {
                if (parseInt(slider.value) >= timeline.length - 1) {
                    slider.value = 0;
                }
                btnPlay.innerHTML = "‚è∏ Pausa";
                btnPlay.classList.replace('btn-primary', 'btn-danger');

                intervalo = setInterval(() => {
                    let val = parseInt(slider.value);
                    if (val < timeline.length - 1) {
                        slider.value = val + 1;
                        // Usamos requestAnimationFrame para suavidad visual
                        requestAnimationFrame(() => dibujarFrame(slider.value));
                    } else {
                        clearInterval(intervalo);
                        intervalo = null;
                        btnPlay.innerHTML = "‚ñ∂ Reproducir";
                        btnPlay.classList.replace('btn-danger', 'btn-primary');
                    }
                }, 100); // 100ms es muy fluido para sampling x2
            }
        });
    </script>
{% endblock %}