<!DOCTYPE html>
{% load l10n %}
<html>
<head>
    <title>{{ estacion.nombre }} - Estad√≠sticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>

<body class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-0">{{ estacion.nombre }}</h1>
            <small class="text-muted">ID: {{ estacion.id_externo }} | Capacidad Total: {{ estacion.capacidad_total }}</small>
        </div>
        <a href="{% url 'lista_estaciones' %}" class="btn btn-outline-secondary">Volver</a>
    </div>

    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card border-success mb-3 h-100">
                <div class="card-header bg-success text-white">Media Bicis</div>
                <div class="card-body">
                    <h2 class="card-title">{{ stats.media_bicis }}</h2>
                    <p class="card-text small text-muted">Promedio disponible</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger mb-3 h-100">
                <div class="card-header bg-danger text-white">Sin Bicis (Vac√≠a)</div>
                <div class="card-body">
                    <h2 class="card-title">{{ stats.pct_sin_bicis }}%</h2>
                    <p class="card-text small text-muted">del tiempo sin stock</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-primary mb-3 h-100">
                <div class="card-header bg-primary text-white">Media Anclajes</div>
                <div class="card-body">
                    <h2 class="card-title">{{ stats.media_anclajes }}</h2>
                    <p class="card-text small text-muted">Huecos libres promedio</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning mb-3 h-100">
                <div class="card-header bg-warning text-dark">Sin Anclajes (Llena)</div>
                <div class="card-body">
                    <h2 class="card-title">{{ stats.pct_sin_anclajes }}%</h2>
                    <p class="card-text small text-muted">del tiempo sin sitio</p>
                </div>
            </div>
        </div>
    </div>


    <style>
    .heatmap-container {
        overflow-x: auto;
    }
    .heatmap-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 2px;
        font-size: 0.75rem;
    }
    .heatmap-cell {
        height: 25px;
        min-width: 25px;
        text-align: center;
        vertical-align: middle;
        border-radius: 3px;
        color: rgba(0,0,0,0.6);
        cursor: pointer;
        transition: transform 0.1s;
    }
    .heatmap-cell:hover {
        transform: scale(1.2);
        border: 1px solid #333;
        z-index: 10;
        font-weight: bold;
        color: black;
    }
    .dia-label {
        font-weight: bold;
        text-align: right;
        padding-right: 8px;
        width: 40px;
    }
    .hora-label {
        text-align: center;
        color: #666;
        font-size: 0.7rem;
    }
</style>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üî• Patrones de Disponibilidad (√öltimos 30 d√≠as)</h5>
        <small class="text-white-50">Rojo = Vac√≠o | Verde = Lleno</small>
    </div>
    <div class="card-body heatmap-container">
        
        <table class="heatmap-table">
            <tr>
                <td></td>
                {% for i in "x"|rjust:"24" %}
                <td class="hora-label">{{ forloop.counter0 }}h</td>
                {% endfor %}
            </tr>

            {% for dia in heatmap_data %}
            <tr>
                <td class="dia-label">{{ dia.nombre }}</td>
                
                {% load l10n %} 

                {% for valor in dia.horas %}
                    {% if valor is None %}
                        <td class="heatmap-cell" style="background-color: #f8f9fa;" title="Sin datos de lectura">
                            <span style="opacity: 0.2;">¬∑</span>
                        </td>
                    {% else %}
                        <td class="heatmap-cell" 
                            title="{{ dia.nombre }} {{ forloop.counter0 }}:00 - Promedio: {{ valor }} bicis"
                            style="
                                /* IMPORTANTE: Usamos |unlocalize para que ponga 5.0 en vez de 5,0 */
                                --capacidad: {{ estacion.capacidad_total|default:20|unlocalize }};
                                --valor: {{ valor|unlocalize }};
                                
                                /* F√≥rmula de color HSL */
                                background-color: hsl(calc( (var(--valor) / var(--capacidad)) * 120 ), 80%, 75%);
                            ">
                            <span style="font-size: 0.6rem; opacity: 0.5;">{{ valor|floatformat:0 }}</span>
                        </td>
                    {% endif %}
                {% endfor %}    
            </tr>
            {% endfor %}
        </table>
        <div class="text-center mt-2 small text-muted">
            Los colores representan el promedio de bicicletas disponibles a esa hora y d√≠a de la semana.
        </div>
    </div>
</div>






    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light fw-bold">Disponibilidad: Bicis vs Anclajes</div>
        <div class="card-body">
            <canvas id="miGrafico" height="80"></canvas>
        </div>
    </div>

    <h3>Historial Reciente</h3>
    <table class="table table-sm table-hover mt-3">
        <thead class="table-light">
            <tr>
                <th>Hora</th>
                <th>Bicis</th>
                <th>Anclajes</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for lectura in lecturas %}
            <tr>
                <td>{{ lectura.captura.timestamp|date:"d/m H:i" }}</td>
                
                <td class="{% if lectura.bicis_disponibles == 0 %}table-danger fw-bold{% else %}text-success{% endif %}">
                    {{ lectura.bicis_disponibles }}
                </td>
                
                <td class="{% if lectura.anclajes_libres == 0 %}table-warning fw-bold{% else %}text-primary{% endif %}">
                    {{ lectura.anclajes_libres }}
                </td>

                <td>
                    {% if lectura.estado == 'OPN' %}
                        <span class="badge bg-success">Abierta</span>
                    {% else %}
                        <span class="badge bg-danger">{{ lectura.estado }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const ctx = document.getElementById('miGrafico').getContext('2d');
        
        const dataBicis = {{ dataset_bicis|safe }};
        const dataAnclajes = {{ dataset_anclajes|safe }};

        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Bicis Disponibles',
                        data: dataBicis,
                        borderColor: '#198754', // Verde
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.1,
                        fill: false, // Solo l√≠nea para ver mejor el cruce
                        borderWidth: 2
                    },
                    {
                        label: 'Anclajes Libres',
                        data: dataAnclajes,
                        borderColor: '#0d6efd', // Azul Bootstrap
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: { minute: 'HH:mm' }
                        },
                        title: { display: true, text: 'Hora' }
                    },
                    y: {
                        beginAtZero: true,
                        // Usamos la capacidad total si existe, si no 20 como fallback
                        suggestedMax: {{ estacion.capacidad_total|default:20 }},
                        title: { display: true, text: 'Unidades' }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    </script>
</body>
</html>